---
layout: post
title:  "ECS More Like EZ...S"
date:   2016-12-30 12:00:01
categories: development
comments: true
image:
  feature: month-in-development-header.png
---

One of the biggest changes I glossed over fairly quickly in my [last blog post](/development/return-of-the-jedai/) was the introduction of the Entity Component System (ECS) pattern to Ripple's codebase. For this blog post I thought I'd dive in a little deeper into what the ECS pattern is and what my specific recipe for baking it into Ripple's code looks like.

<p class="note" markdown="1">While most of my blog posts are targetted at anyone who is interested in the game, this is a more technical post and will focus on programming architecture and implementation details.</p>

## What Is ECS

* Id = entity
* Components are isolated pieces of functionality that exist as bits of state
* Systems operate on each component of the same type as it. AgentSystem operates on Agent components

### Composition Over Inheritance

At its core the ECS pattern boils down to ["composition over inheritance"](https://en.wikipedia.org/wiki/Composition_over_inheritance). If you've ever taken a software architecture course or have been programming longer than a year it's a design principle you've probably ran into before. Basically whenever you rely heavily on inheritance trees, given enough changes, you'll end up in a situation where adding a new class will require refactoring large parts of the tree to allow it to fit into the heirarchy. In short, inheritance is often not very flexible.

<p class="note" markdown="1">If you're looking for a more a thorough overview of the ECS pattern I would take a look at the [Component chapter](http://gameprogrammingpatterns.com/component.html) from the wonderful [Game Programming Patterns](http://gameprogrammingpatterns.com/) book by Bob Nystrom.</p>

An example from Ripple was when I was thinking about adding a `StorageCart` class to the game. I already had a `Building` class which encompassed the functionality like storing items and being a constructible entity. But a cart should move right? Well buildings can't move but I had an `Agent` class, a parent class for monsters and people, that had this behavior. That means I would have to pull all of that functionality from both classes into a shared class that the `Building`, `Agent`, and `StorageCart` classes inherited from. This doesn't seem particularly elegant. Especially as you can imagine this situation arising over and over until you have a super bloated `EntityThatDoesEverything` top level class.

My halfway solution was to follow this "composition over inheritance" motto directly. If an entity needed storage functionality then it would have a storage property, `entity.storage`, which would be an instance of the `Storage` class. This class would encapsulate all of the functionality around storing items and could be attached to any other entity class.

Now at this point I started to convert pieces of functionality over to this format, where functionality was encompassed in classes that existed as instances of entities. But I realized by doing this I was essentially implementing a half-assed version of ECS. Bored and frustrated, I decided to go whole-ass with my solution and move everything to ECS.

### OK. But Really What Is ECS?

I mentioned you could separate out different pieces of functionality into different classes and then have those classes attached to your entities. If we did this with every piece of functionality what would our entity class be left with? A decrepit vessel for pointers, a husk floating through the void of code. Or maybe just an identifying piece of information, an id.

The core parts of the ECS framework are <small>surprise</small> Entities, Components, and Systems. And in ECS, this id *is* the entity. Components are raw data representing one piece of functionality (`MoveComponent`, `PoisonComponent`). Systems, which are tied to a specific type of Component, operate on each Component of their type every turn (`MoveSystem` operates on every `MoveComponent`).

### Ripple ECS Architecture

If you're not familiar with ECS that super brief into might have confused you but I figure it will be more illuminating to explain each piece as it exists in my implementation so I'm not repeating myself. So let's jump in.

#### Entities

The first piece of the puzzle are entities, the most simple concept to grapple with. An entity in ECS is just an id with a number of components tied to it. By tied I just mean, given an entity's id, you can fetch any component for that entity. Think of it as a primary key in a database.

#### Components

